/**
 * Generates 500 synthetic penetration testing job postings for MVP skill-gap engine.
 * Run from repo root: node scripts/generate-pentest-jobs.js
 */

const fs = require('fs');
const path = require('path');

// --- Pools (realistic industry terms) ---

const titlesBySeniority = {
  junior: [
    'Junior Penetration Tester',
    'Associate Security Consultant',
    'Junior Offensive Security Analyst',
    'Entry-Level Penetration Tester',
    'Junior Red Team Analyst',
  ],
  mid: [
    'Penetration Tester',
    'Security Consultant - Penetration Testing',
    'Offensive Security Engineer',
    'Mid-Level Penetration Tester',
    'Security Assessor',
  ],
  senior: [
    'Senior Penetration Tester',
    'Senior Offensive Security Engineer',
    'Lead Penetration Tester',
    'Senior Red Team Operator',
    'Principal Security Consultant',
  ],
  lead: [
    'Lead Penetration Tester',
    'Offensive Security Lead',
    'Red Team Lead',
    'Principal Penetration Tester',
    'Head of Offensive Security',
  ],
};

const skillPool = [
  'Web application penetration testing',
  'Network penetration testing',
  'OWASP Top 10',
  'Burp Suite',
  'Nmap',
  'Metasploit',
  'Active Directory exploitation',
  'Privilege escalation',
  'API security testing',
  'Cloud security (AWS/Azure/GCP)',
  'Linux/Windows exploitation',
  'Scripting (Python/Bash)',
  'Social engineering',
  'Phishing assessments',
  'Wireless security testing',
  'Source code review',
  'Red team operations',
  'Purple team collaboration',
  'Vulnerability assessment',
  'Report writing',
  'CVSS and risk rating',
  'Kerberos and AD attacks',
  'Container security',
  'CI/CD pipeline security',
  'Mobile app security',
  'Thick client testing',
  'OSINT',
  'C2 frameworks',
  'Evasion techniques',
  'Binary exploitation',
  'Secure code review',
  'Threat modeling',
];

const niceToHavePool = [
  'OSCP or equivalent',
  'OSEP',
  'CISSP',
  'CRTO',
  'Cloud certifications',
  'Programming (Python, Go)',
  'Malware analysis',
  'ICS/SCADA',
  'DevSecOps',
  'Bug bounty experience',
  'CTF experience',
  'Incident response',
  'Forensics',
  'Compliance (PCI, SOC2)',
];

const toolsPool = [
  'Burp Suite Pro',
  'Nmap',
  'Metasploit',
  'Cobalt Strike',
  'BloodHound',
  'Mimikatz',
  'Responder',
  'Impacket',
  'Wireshark',
  'Nessus',
  'Qualys',
  'SQLMap',
  'ffuf',
  'nuclei',
  'Hashcat',
  'John the Ripper',
  'Chisel',
  'Cloud-specific tools (Pacu, ScoutSuite)',
];

const responsibilitiesPool = [
  'Conduct penetration tests and document findings.',
  'Deliver clear written and verbal reports to stakeholders.',
  'Perform scoped red team engagements.',
  'Identify and exploit vulnerabilities in line with rules of engagement.',
  'Support remediation and retesting.',
  'Maintain and use testing infrastructure and tooling.',
  'Mentor junior team members.',
  'Contribute to methodology and standards.',
  'Scope and lead client engagements.',
];

// Certification bands by years of experience
function getCertificationsForYears(years) {
  if (years <= 2) return ['eJPT', 'CEH (theory)', 'Security+'];
  if (years <= 5) return ['CEH', 'PNPT', 'GWAPT', 'CRTO'];
  if (years <= 8) return ['OSCP', 'OSEP', 'CRTO', 'eWPTX'];
  return ['OSCE', 'OSEE', 'CISSP'];
}

function getSeniority(years) {
  if (years <= 2) return 'junior';
  if (years <= 5) return 'mid';
  if (years <= 8) return 'senior';
  return 'lead';
}

function pickN(arr, n, seed) {
  const out = [];
  const indices = new Set();
  let s = seed;
  while (out.length < n && out.length < arr.length) {
    s = (s * 1103515245 + 12345) >>> 0;
    const idx = s % arr.length;
    if (indices.has(idx)) continue;
    indices.add(idx);
    out.push(arr[idx]);
  }
  return out;
}

function shuffleSlice(arr, n, seed) {
  const copy = [...arr];
  let s = seed;
  for (let i = copy.length - 1; i > 0; i--) {
    s = (s * 1103515245 + 12345) >>> 0;
    const j = s % (i + 1);
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy.slice(0, n);
}

const jobs = [];
const usedSkillKeys = new Set();

for (let i = 0; i < 500; i++) {
  const years = (i % 10) + 1;
  const seniority = getSeniority(years);
  const certs = getCertificationsForYears(years);
  const seed = i * 7919 + 1;

  const numRequired = 5 + (i % 4);
  const numNice = 2 + (i % 4);
  let requiredSkills;
  let skillKey;
  for (let attempt = 0; attempt < 20; attempt++) {
    requiredSkills = shuffleSlice(skillPool, Math.min(numRequired, skillPool.length), seed + attempt * 1000);
    skillKey = [...requiredSkills].sort().join('|');
    if (!usedSkillKeys.has(skillKey)) break;
  }
  usedSkillKeys.add(skillKey);
  const niceToHaveSkills = shuffleSlice(niceToHavePool, Math.min(numNice, niceToHavePool.length), seed + 7);

  const numCerts = 1 + (i % Math.min(3, certs.length));
  const certifications = shuffleSlice(certs, numCerts, seed + 11);
  const numTools = 4 + (i % 5);
  const tools = shuffleSlice(toolsPool, Math.min(numTools, toolsPool.length), seed + 13);
  const numResp = 3 + (i % 4);
  const responsibilities = shuffleSlice(responsibilitiesPool, Math.min(numResp, responsibilitiesPool.length), seed + 17);

  const titleList = titlesBySeniority[seniority];
  const title = titleList[i % titleList.length];

  jobs.push({
    jobId: `pentest-${i + 1}`,
    title,
    yearsOfExperience: years,
    requiredSkills,
    niceToHaveSkills,
    certifications,
    tools,
    responsibilities,
    seniorityLevel: seniority,
  });
}

const outPath = path.join(__dirname, '..', 'data', 'penetration_testing_jobs.json');
fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, JSON.stringify(jobs, null, 2), 'utf8');
console.log('Wrote', jobs.length, 'jobs to', outPath);
